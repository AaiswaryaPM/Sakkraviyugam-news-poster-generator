<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakkaraviyugam - News Poster Editor Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Arima:wght@700&family=Hind+Madurai:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --brand: #ff0000; 
            --accent-blue: #0056b3;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1c1e21;
            --sep: #e0e0e0;
            --news-font: 'Hind Madurai', 'Segoe UI', sans-serif;
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; background: var(--bg); color: var(--text); 
            display: flex; height: 100vh; overflow: hidden;
        }

        /* Sidebar & Tabs */
        .sidebar { 
            width: 400px; background: var(--card); display: flex; flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.1); z-index: 20;
        }
        .brand-header { padding: 20px 20px 10px 20px; text-align: center; position: relative; }
        .brand-header h1 { margin: 0; color: var(--brand); font-size: 24px; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .brand-header p { margin: 2px 0 0 0; font-size: 11px; text-transform: uppercase; color: #65676b; font-weight: bold; letter-spacing: 2px; }

        .history-controls { display: flex; gap: 10px; padding: 0 20px 15px; border-bottom: 1px solid #eee; }
        .btn-hist { 
            flex: 1; padding: 8px; font-size: 11px; background: #f0f2f5; 
            border: 1px solid #ddd; border-radius: 6px; cursor: pointer; 
            font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: all 0.2s;
        }
        .btn-hist:hover:not(:disabled) { background: #e4e6eb; }
        .btn-hist:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-hist svg { width: 14px; height: 14px; fill: currentColor; }

        .tabs { display: flex; border-bottom: 1px solid #ddd; background: #fcfcfc; }
        .tab-btn { flex: 1; padding: 14px; border: none; background: none; cursor: pointer; font-weight: bold; color: #65676b; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--brand); border-bottom-color: var(--brand); background: white; }
        
        .tab-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Form Styling */
        .section-title { font-size: 12px; color: var(--brand); text-transform: uppercase; font-weight: 800; margin-bottom: 15px; border-left: 3px solid var(--brand); padding-left: 8px; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #444; }
        
        .slider-card { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .slider { -webkit-appearance: none; width: 100%; height: 5px; background: #dfe3e8; border-radius: 10px; outline: none; margin: 10px 0; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--brand); border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Preview Area */
        .preview-pane { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #cbd5e0; padding: 20px; position: relative; overflow: hidden; touch-action: none; }
        #scale-wrapper { transform-origin: center; transition: transform 0.05s linear; will-change: transform; display: flex; align-items: center; justify-content: center; }
        
        #poster-canvas {
            width: 800px; height: 800px; background: #fff; position: relative; 
            overflow: hidden; box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            font-family: var(--news-font);
        }

        .paper-texture { position: absolute; inset: 0; opacity: 0.05; pointer-events: none; z-index: 2; background-image: url("https://www.transparenttextures.com/patterns/graphy.png"); }
        #bg-layer { position: absolute; inset: 0; width: 800px; height: 800px; object-fit: fill; z-index: 1; }
        .dot-design{ width: 10px; height: 10px; background-color: white; border-radius: 50%; position: absolute; top: 72px; left:250px; z-index: 1; }

        .top-separator { position: absolute; top: 115px; left: 30px; right: 30px; height: 1px; background: var(--sep); z-index: 5; }
        .meta-bar {
            position: absolute; top: 115px; left: 30px; right: 30px; height: 50px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 6; font-weight: 700; font-size: 20px; color: #222;
        }
        .meta-item { display: flex; align-items: center; gap: 8px; }
        .meta-icon { width: 20px; height: 20px; fill: var(--brand); }
        
        .blue-line { position: absolute; top: 155px; left: 30px; right: 30px; height: 2px; background: rgb(19, 36, 133); z-index: 6; }
        .bottom-separator { position: absolute; bottom: 75px; left: 30px; right: 30px; height: 1px; background: var(--sep); z-index: 5; }

        .content-frame {
            position: absolute; top: 165px; bottom: 90px; left: 30px; right: 30px;
            border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; pointer-events: none; z-index: 3;
            background: rgba(255,255,255,0.2);
        }

        .main-content-area {
            position: absolute; top: 170px; width: 720px; height: 540px; left: 40px;
            display: flex; flex-direction: column; align-items: center; z-index: 4;
        }

        .dyn-img-box { width: 100%; overflow: hidden; cursor: grab; display: flex; justify-content: center; border-radius: 4px; touch-action: none; }
        #view-img { position: relative; transform-origin: center; }
        .divider-line { width: 95%; height: 2px; background: var(--brand); margin: 15px 0; display: none; }
        .text-wrap { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 10px; text-align: center; overflow: hidden; width: 100%; }
        .dyn-text { font-weight: 700; color: #000; width: 100%; word-wrap: break-word; letter-spacing: -0.5px; outline: none; border: 1px dashed transparent; font-size: 32px; }
        .dyn-text:focus { border-color: #ccc; background: rgba(0,0,0,0.02); }

        .footer-container { 
            position: absolute; bottom: 0; width: 100%; height: 75px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 45px; box-sizing: border-box; z-index: 5; 
        }
        .footer-left, .footer-right { color: white; font-weight: 700; font-size: 19px; width: 35%; text-align: center; line-height: 1.2; outline: none; }

        .btn-stack { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-save { background: var(--brand); color: white; box-shadow: 0 4px 12px rgba(255,0,0,0.2); }
        .btn-reset { background: #f0f2f5; color: #444; }
        .btn:active { transform: scale(0.98); }

        [contenteditable="true"] { pointer-events: auto !important; cursor: text; }

        /* Mobile Responsiveness Updates */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow: hidden; height: 100vh; }
            
            /* Fixed Header for Mobile */
            .brand-header { 
                position: fixed; top: 0; left: 0; right: 0; height: 60px; 
                background: white; z-index: 100; display: flex; align-items: center; 
                justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .brand-header img { width: 140px !important; margin: 0; }
            .brand-header p { display: none; }

            /* Horizontal History + Download in Header */
            .sidebar .history-controls { display: none; }
            .mobile-header-controls {
                display: flex !important; align-items: center; gap: 8px;
            }
            .mobile-header-controls .btn-hist { padding: 6px; width: 35px; height: 35px; min-width: 35px; flex: none; border-radius: 50%; }
            .mobile-header-controls .btn-hist span { display: none; }
            .mobile-header-controls .btn-save-mini { 
                background: var(--brand); color: white; border: none; border-radius: 50%; 
                width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
                cursor: pointer;
            }
            .mobile-header-controls svg { width: 18px; height: 18px; fill: currentColor; }

            /* Sticky Preview Panel - FIXED SIZE AS REQUESTED */
            .preview-pane { 
                position: fixed; top: 60px; left: 0; right: 0; height: 40vh; 
                background: #2d3436; z-index: 90; padding: 0; 
                overflow: hidden; 
            }

            /* Scrollable Sidebar/Editor Area */
            .sidebar { 
                position: fixed; top: calc(40vh + 60px); bottom: 0; left: 0; right: 0; 
                width: 100%; height: auto; overflow-y: auto; background: white; 
                z-index: 80; display: block;
            }
            .tab-content { overflow-y: visible; padding-bottom: 20px; }

            /* Hide Bottom Buttons */
            .btn-stack { display: none !important; }
        }

        .mobile-header-controls { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand-header">
        <img src="images/logo.jpg" style="width:90%;">
        <p>News Poster Editor</p>
        
        <div class="mobile-header-controls">
            <button class="btn-hist undo-btn-shared" onclick="undo()" disabled>
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button class="btn-hist redo-btn-shared" onclick="redo()" disabled>
                <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
            </button>
            <button class="btn-save-mini" onclick="saveAsImage()">
                <svg viewBox="0 0 24 24" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
        </div>
    </div>

    <div class="history-controls">
        <button class="btn-hist undo-btn-shared" onclick="undo()" disabled title="Undo">
            <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            <span style="display:inline-block; margin-left:5px;">UNDO</span>
        </button>
        <button class="btn-hist redo-btn-shared" onclick="redo()" disabled title="Redo">
            <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
            <span style="display:inline-block; margin-left:5px;">REDO</span>
        </button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tab-design')">Design</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-content')">Text Align</button>
    </div>

    <div class="tab-content">
        <div id="tab-design" class="tab-pane active">
            <div class="section-title">Visual Elements</div>
            <div class="input-group">
                <label>1. Poster Template (பின்னணி)</label>
                <input type="file" id="template-file" accept="image/*" onchange="loadTemplate(this)">
            </div>
            <div class="input-group">
                <label>2. Main Photo (படம்)</label>
                <input type="file" id="image-file" accept="image/*" onchange="loadImage(this)">
            </div>
            
            <div id="image-adjustments" class="slider-card" style="display:none;">
                <div class="section-title" style="border:none; padding:0; margin-bottom:10px;">Photo Controls</div>
                <label>Width Scaling</label>
                <input type="range" id="in-width" class="slider" min="10" max="100" value="95" oninput="adjustImage()" onchange="saveHistory()">
                <label>Frame Height</label>
                <input type="range" id="in-height" class="slider" min="50" max="450" value="320" oninput="adjustImage()" onchange="saveHistory()">
                <label>Side Cropping</label>
                <input type="range" id="in-crop" class="slider" min="0" max="45" value="0" oninput="adjustImage()" onchange="saveHistory()">
                <label>Photo Zoom</label>
                <input type="range" id="in-zoom" class="slider" min="0.5" max="3" step="0.05" value="1" oninput="adjustImage()" onchange="saveHistory()">
            </div>
        </div>

        <div id="tab-content" class="tab-pane">
            <div class="section-title">Visual Tweaks</div>
            <div class="input-group slider-card">
                <label>Line Spacing (வரி இடைவெளி)</label>
                <input type="range" id="in-lineheight" class="slider" min="1" max="2.5" step="0.1" value="1.4" oninput="update()" onchange="saveHistory()">
            </div>
        </div>
    </div>

    <div class="btn-stack">
        <button class="btn btn-reset" onclick="location.reload()">RESET</button>
        <button class="btn btn-save" id="save-btn" onclick="saveAsImage()">DOWNLOAD POSTER</button>
    </div>
</div>

<div class="preview-pane">
    <div id="scale-wrapper">
        <div id="poster-canvas">
            <img id="bg-layer" src="">
            <div class="paper-texture"></div>
            <div class="content-frame"></div>
            
            <div class="dot-design"></div>
            <div class="top-separator"></div>
            <div class="meta-bar">
                <div class="meta-item">
                    <svg class="meta-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    <span id="view-loc" contenteditable="true">சென்னை</span>
                </div>
                <div class="meta-item">
                    <svg class="meta-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                    <span id="view-date" contenteditable="true"></span>
                </div>
            </div>
            <div class="blue-line"></div>
            <div class="bottom-separator"></div>

            <div class="main-content-area">
                <div class="dyn-img-box" id="img-box">
                    <img id="view-img" src="" style="display:none;">
                </div>
                <div class="divider-line" id="red-line"></div>
                <div class="text-wrap" id="text-wrap-div">
                    <div class="dyn-text" id="view-text" contenteditable="true">உங்கள் செய்தியை இங்கே பதிவிடவும்...</div>
                </div>
            </div>

            <div class="footer-container">
                <div class="footer-left" id="view-desig" contenteditable="true">செய்தியாளர்</div>
                <div class="footer-right" id="view-name" contenteditable="true">பெயர்</div>
            </div>
        </div>
    </div>
</div>

<script>
    let posX = 0, posY = 0, scale = 1;
    const wrapper = document.getElementById('scale-wrapper');
    const previewPane = document.querySelector('.preview-pane');
    let historyStack = [];
    let redoStack = [];
    const maxHistory = 30;

    // Mobile Preview Navigation State
    let mobileZoom = 1;
    let mobilePanX = 0;
    let mobilePanY = 0;
    let initialDist = 0;
    let lastTouchX = 0;
    let lastTouchY = 0;

    window.onload = function() {
        const now = new Date();
        const d = String(now.getDate()).padStart(2, '0');
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const y = now.getFullYear();
        document.getElementById('view-date').innerText = `${d}.${m}.${y}`;
        update();
        saveHistory();
        responsivePreview();
    };

    function getState() {
        return JSON.stringify({
            loc: document.getElementById('view-loc').innerText,
            date: document.getElementById('view-date').innerText,
            content: document.getElementById('view-text').innerText,
            desig: document.getElementById('view-desig').innerText,
            name: document.getElementById('view-name').innerText,
            lh: document.getElementById('in-lineheight').value,
            w: document.getElementById('in-width').value,
            h: document.getElementById('in-height').value,
            c: document.getElementById('in-crop').value,
            z: document.getElementById('in-zoom').value,
            px: posX, 
            py: posY,
            bgSrc: document.getElementById('bg-layer').src,
            imgSrc: document.getElementById('view-img').src,
            imgVisible: document.getElementById('view-img').style.display
        });
    }

    function saveHistory() {
        const current = getState();
        if (historyStack.length > 0 && historyStack[historyStack.length - 1] === current) return;
        historyStack.push(current);
        if (historyStack.length > maxHistory) historyStack.shift();
        redoStack = [];
        updateHistoryButtons();
    }

    function undo() {
        if (historyStack.length <= 1) return;
        const currentState = historyStack.pop();
        redoStack.push(currentState);
        const prevState = historyStack[historyStack.length - 1];
        applyState(prevState);
    }

    function redo() {
        if (redoStack.length === 0) return;
        const nextState = redoStack.pop();
        historyStack.push(nextState);
        applyState(nextState);
    }

    function applyState(stateStr) {
        const s = JSON.parse(stateStr);
        document.getElementById('view-loc').innerText = s.loc;
        document.getElementById('view-date').innerText = s.date;
        document.getElementById('view-text').innerText = s.content;
        document.getElementById('view-desig').innerText = s.desig;
        document.getElementById('view-name').innerText = s.name;
        document.getElementById('in-lineheight').value = s.lh;
        document.getElementById('in-width').value = s.w;
        document.getElementById('in-height').value = s.h;
        document.getElementById('in-crop').value = s.c;
        document.getElementById('in-zoom').value = s.z;
        posX = s.px; 
        posY = s.py;
        document.getElementById('bg-layer').src = s.bgSrc || "";
        const viewImg = document.getElementById('view-img');
        viewImg.src = s.imgSrc || "";
        viewImg.style.display = s.imgVisible;
        if(s.imgVisible === 'block') {
            document.getElementById('red-line').style.display = 'block';
            document.getElementById('image-adjustments').style.display = 'block';
        }
        update();
        adjustImage();
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        const undoBtns = document.querySelectorAll('.undo-btn-shared');
        const redoBtns = document.querySelectorAll('.redo-btn-shared');
        undoBtns.forEach(b => b.disabled = historyStack.length <= 1);
        redoBtns.forEach(b => b.disabled = redoStack.length === 0);
    }

    function openTab(evt, tabName) {
        let panes = document.getElementsByClassName("tab-pane");
        for (let p of panes) p.classList.remove("active");
        let btns = document.getElementsByClassName("tab-btn");
        for (let b of btns) b.classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    function responsivePreview() {
        const pane = document.querySelector('.preview-pane');
        const baseScale = Math.min((pane.offsetWidth * 0.95) / 800, (pane.offsetHeight * 0.95) / 800);
        
        // Apply responsive scale + user mobile zoom + user mobile panning
        wrapper.style.transform = `scale(${baseScale * mobileZoom}) translate(${mobilePanX}px, ${mobilePanY}px)`;
    }
    window.addEventListener('resize', responsivePreview);

    // MOBILE PREVIEW: PINCH ZOOM + PANNING FOR THE ENTIRE PREVIEW
    previewPane.addEventListener('touchstart', (e) => {
        if (window.innerWidth <= 900) {
            // Check if we are touching the image drag box (don't interfere with existing image drag)
            if (e.target.closest('#img-box')) return;

            if (e.touches.length === 2) {
                initialDist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
            } else if (e.touches.length === 1) {
                lastTouchX = e.touches[0].pageX;
                lastTouchY = e.touches[0].pageY;
            }
        }
    }, {passive: true});

    previewPane.addEventListener('touchmove', (e) => {
        if (window.innerWidth <= 900) {
            if (e.target.closest('#img-box')) return;

            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                const delta = dist / initialDist;
                mobileZoom = Math.min(Math.max(mobileZoom * delta, 0.5), 8);
                initialDist = dist;
                responsivePreview();
            } else if (e.touches.length === 1 && mobileZoom > 1) {
                // Allow panning only when zoomed in
                const dx = (e.touches[0].pageX - lastTouchX) / mobileZoom;
                const dy = (e.touches[0].pageY - lastTouchY) / mobileZoom;
                mobilePanX += dx;
                mobilePanY += dy;
                lastTouchX = e.touches[0].pageX;
                lastTouchY = e.touches[0].pageY;
                responsivePreview();
            }
        }
    }, {passive: false});

    function loadTemplate(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('bg-layer').src = e.target.result;
                saveHistory();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function loadImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('view-img');
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('red-line').style.display = 'block';
                document.getElementById('image-adjustments').style.display = 'block';
                adjustImage();
                saveHistory();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    const imgBox = document.getElementById('img-box');
    let isDragging = false, startX, startY;
    
    const startDrag = (e) => {
        if(e.target.contentEditable === "true" || (e.touches && e.touches.length > 1)) return; 
        isDragging = true;
        const c = e.touches ? e.touches[0] : e;
        startX = c.clientX - posX; startY = c.clientY - posY;
    };
    const moveDrag = (e) => {
        if (!isDragging || (e.touches && e.touches.length > 1)) return;
        const c = e.touches ? e.touches[0] : e;
        posX = c.clientX - startX; posY = c.clientY - startY;
        adjustImage();
    };
    imgBox.addEventListener('mousedown', startDrag);
    imgBox.addEventListener('touchstart', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, {passive: false});
    window.addEventListener('mouseup', () => { if(isDragging) saveHistory(); isDragging = false; });
    window.addEventListener('touchend', () => { if(isDragging) saveHistory(); isDragging = false; });

    function adjustImage() {
        const img = document.getElementById('view-img');
        const w = document.getElementById('in-width').value;
        const h = document.getElementById('in-height').value;
        const crop = document.getElementById('in-crop').value;
        scale = document.getElementById('in-zoom').value;
        img.style.width = w + "%";
        img.style.height = h + "px";
        img.style.clipPath = `inset(0% ${crop}% 0% ${crop}%)`;
        img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        autoSizeText();
    }

    function update() {
        document.getElementById('view-text').style.lineHeight = document.getElementById('in-lineheight').value;
        autoSizeText();
    }

    function autoSizeText() {
        const textEl = document.getElementById('view-text');
        const wrapEl = document.getElementById('text-wrap-div');
        let fontSize = 32; 
        textEl.style.fontSize = fontSize + "px";
        textEl.style.fontWeight = "700";

        while (textEl.scrollHeight > wrapEl.clientHeight && fontSize > 14) {
            fontSize--;
            textEl.style.fontSize = fontSize + "px";
        }
    }

    async function saveAsImage() {
        if (!document.getElementById('bg-layer').src) return alert("Please select a template first!");
        const btn = document.getElementById('save-btn');
        btn.innerText = "Processing...";
        const canvasWrapper = document.getElementById('scale-wrapper');
        const originalTransform = canvasWrapper.style.transform;
        
        // Reset for high-res capture
        canvasWrapper.style.transform = 'none';

        try {
            const canvas = await html2canvas(document.getElementById('poster-canvas'), {
                scale: 2, useCORS: true, width: 800, height: 800
            });
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `News_${Date.now()}.png`;
            link.click();
        } catch (e) { console.error(e); }
        
        canvasWrapper.style.transform = originalTransform;
        btn.innerText = "DOWNLOAD POSTER";
    }

    document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.addEventListener('blur', () => saveHistory());
        el.addEventListener('input', () => {
            if(el.id === 'view-text') autoSizeText();
        });
        el.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        });
    });
</script>
</body>
</html>